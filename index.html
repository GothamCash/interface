<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>GothamCash - BNB Mixer</title>

  <!-- web3.js CDN -->
  <script src="https://cdn.jsdelivr.net/npm/web3@1.10.0/dist/web3.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>

  <style>
    /* Reset minimal */
    * {
      margin: 0; padding: 0; box-sizing: border-box;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    }
    body, html {
      height: 100%;
      background: url('gotham-city-bg.jpg') no-repeat center center fixed;
      background-size: cover;
      background-color: #121212;
      color: #eee;
      display: flex;
      justify-content: center;
      align-items: center;
    }
    .container {
      background: rgba(18, 18, 18, 0.9);
      border-radius: 20px;
      width: 400px;
      max-width: 95vw;
      padding: 25px;
      box-shadow: 0 0 20px rgba(0,0,0,0.7);
    }
    h1 {
      text-align: center;
      margin-bottom: 20px;
      color: #ffae00; /* Gotham yellow */
      text-shadow: 0 0 6px #ffae00;
    }

    /* Tabs */
    .tabs {
      display: flex;
      justify-content: center;
      margin-bottom: 20px;
      user-select: none;
    }
    .tab {
      flex: 1;
      padding: 10px 0;
      cursor: pointer;
      text-align: center;
      font-weight: 600;
      color: #bbb;
      border-bottom: 3px solid transparent;
      transition: all 0.3s ease;
    }
    .tab.active {
      color: #ffae00;
      border-color: #ffae00;
    }

    /* Tab content */
    .tab-content {
      display: none;
      animation: fadeIn 0.4s ease forwards;
    }
    .tab-content.active {
      display: block;
    }

    @keyframes fadeIn {
      from {opacity: 0;}
      to {opacity: 1;}
    }

    /* Forms */
    label {
      display: block;
      margin-bottom: 6px;
      font-weight: 600;
      color: #ccc;
    }
    input, button, textarea {
      width: 100%;
      padding: 10px;
      margin-bottom: 15px;
      border-radius: 12px;
      border: none;
      outline: none;
      font-size: 1rem;
      background-color: #222;
      color: #eee;
      transition: background-color 0.3s ease;
    }
    input:focus, textarea:focus {
      background-color: #333;
    }
    button {
      background-color: #ffae00;
      color: #121212;
      font-weight: 700;
      cursor: pointer;
      box-shadow: 0 0 8px #ffae00;
      transition: background-color 0.3s ease;
    }
    button:hover {
      background-color: #e59e00;
    }

    /* Status messages */
    #status {
      padding: 10px;
      background: #222;
      border-radius: 12px;
      color: #eee;
      min-height: 40px;
      font-size: 0.9rem;
      margin-top: 10px;
      text-align: center;
      user-select: text;
      white-space: pre-wrap;
    }

    /* Wallet button */
    #connectWalletBtn {
      width: 100%;
      margin-bottom: 20px;
    }
	
	/* Beneficiary address */
	input:disabled {
	  background-color: #1a1a1a;
	  color: #777;
	  cursor: not-allowed;
	}
  </style>
</head>
<body>
  <div class="container">
    <h1>GothamCash</h1>

    <button id="connectWalletBtn">Connect Wallet</button>

    <div class="tabs">
      <div class="tab active" data-tab="deposit">Deposit 0.1 BNB</div>
      <div class="tab" data-tab="withdraw">Withdraw 0.1 BNB</div>
    </div>

    <div id="deposit" class="tab-content active">
      <label for="depositNote">Salt (word, phrase, random characters)</label>
      <textarea id="depositNote" rows="3" placeholder="Enter a salt to encrypt your deposit"></textarea>
	  <p id="depositCount" style="text-align:center; margin-bottom: 15px; font-size: 0.9rem; color: #bbb;">
		Equivalent deposits: loading...
	  </p>
      <button id="depositBtn">Deposit 0.1 BNB</button>
    </div>

    <div id="withdraw" class="tab-content">
      <label for="withdrawNote">Note (generated on deposit)</label>
      <textarea id="withdrawNote" rows="3" placeholder="Enter the generated note..."></textarea>

      <label for="recipientAddress">Beneficiary</label>
      <input id="recipientAddress" type="text" placeholder="BSC 0x address that will receive the funds" />
	  <label style="display: flex; align-items: center; gap: 8px; font-weight: normal;">
	    <input type="checkbox" id="useConnectedAddress" style="width: auto; margin: 0;" />
	    Use the connected address
	  </label>
	  <br>
      <button id="withdrawBtn">Withdraw 0.1 BNB</button>
    </div>

    <div id="status"></div>

  </div>

  <script>
	const contractABI = [
	  {
		"inputs": [{"internalType":"bytes32","name":"commitment","type":"bytes32"}],
		"name":"deposit",
		"outputs":[],
		"stateMutability":"payable",
		"type":"function"
	  },
	  {
		"inputs":[
		  {"internalType":"bytes32","name":"nullifierHash","type":"bytes32"},
		  {"internalType":"bytes32","name":"commitment","type":"bytes32"},
		  {"internalType":"address payable","name":"recipient","type":"address"}
		],
		"name":"withdraw",
		"outputs":[],
		"stateMutability":"nonpayable",
		"type":"function"
	  },
	  {
		"inputs": [],
		"name": "feesEnabled",
		"outputs": [
		  {
			"internalType": "bool",
			"name": "",
			"type": "bool"
		  }
		],
		"stateMutability": "view",
		"type": "function"
	  }
	];

    // Contract address (testnet)
    const contractAddress = '0x8aafacc9027d51595b4519052e6b14a11cb46e18';

    let web3;
    let contract;
    let accounts = [];
	
	// Web3 in read-only (for the stats)
	let web3Stats;
	let contractStats;
	
	function initStatsReader() {
	  const bscProvider = 'https://data-seed-prebsc-2-s2.bnbchain.org:8545'; //testnet
	  //const bscProvider = 'https://bsc-dataseed.binance.org/'; //mainnet
	  web3Stats = new Web3(bscProvider);
	  contractStats = new web3Stats.eth.Contract(contractABI, contractAddress);
	}

    const statusEl = document.getElementById('status');
    const connectWalletBtn = document.getElementById('connectWalletBtn');

    // Switch tabs
    document.querySelectorAll('.tab').forEach(tab => {
      tab.addEventListener('click', () => {
		  document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
		  document.querySelectorAll('.tab-content').forEach(tc => tc.classList.remove('active'));

		  tab.classList.add('active');
		  document.getElementById(tab.getAttribute('data-tab')).classList.add('active');
		  statusEl.textContent = '';
		});
    });

    // Connect wallet function (MetaMask)
    async function connectWallet() {
      if (window.ethereum) {
        try {
          accounts = await window.ethereum.request({ method: 'eth_requestAccounts' });
          web3 = new Web3(window.ethereum);
          contract = new web3.eth.Contract(contractABI, contractAddress);
          statusEl.textContent = `Connected on BSC: ${accounts[0]}`;
          connectWalletBtn.textContent = 'Wallet connected!';
          connectWalletBtn.disabled = true;
			
		  // Links the beneficiary to the connected address, and locks the edits if the checkbox is checked
		  const useAddressCheckbox = document.getElementById('useConnectedAddress');
		  const recipientInput = document.getElementById('recipientAddress');

		  if (useAddressCheckbox) {
			useAddressCheckbox.checked = true;
			recipientInput.value = accounts[0];
			recipientInput.disabled = true;
		  }
			
		  updateDepositStats();

        } catch (err) {
          statusEl.textContent = 'Wallet connection error: ' + err.message;
        }
      } else {
        statusEl.textContent = 'MetaMask not found. Please install MetaMask.';
      }
    }
    connectWalletBtn.onclick = connectWallet;

    // Helper : keccak256 hash (via web3.utils)
    function generateCommitment(note) {
      return web3.utils.keccak256(note);
    }

    // Deposit button
	document.getElementById('depositBtn').onclick = async () => {
	  if (!web3 || !accounts.length) {
		statusEl.textContent = 'Please connect your wallet first.';
		return;
	  }

	  statusEl.textContent = 'Generating note...';

	  // Generate 32 bytes hex for nullifier and secret
	  const randomHex = (bytes = 32) => {
		const array = new Uint8Array(bytes);
		window.crypto.getRandomValues(array);
		return '0x' + Array.from(array).map(b => b.toString(16).padStart(2, '0')).join('');
	  };

	  const nullifierHex = randomHex();
	  const secretHex = randomHex();
	  const fullNoteHex = nullifierHex + secretHex.slice(2);
	  const commitment = web3.utils.keccak256(fullNoteHex);

	  const note = `gothamcash-1:${nullifierHex}:${secretHex}`;

	  statusEl.textContent = 'Depositing...';

	  try {
		const value = await contract.methods.feesEnabled().call();
		let depositAmount = web3.utils.toWei("0.1", "ether");

		if (value) {
		  // If the fees are activated, send 0.1 / (1 - 1%) ≈ 0.10101 ETH
		  depositAmount = web3.utils.toWei((0.1 / 0.99).toFixed(5), "ether");
		}

		await contract.methods.deposit(commitment).send({
		  from: accounts[0],
		  value: depositAmount
		});

		// Display the note
		statusEl.textContent = "✅ Deposit confirmed!";
		showNoteModal(note);

	  } catch (err) {
		console.error(err);
		statusEl.textContent = 'Deposit error: ' + err.message;
	  }
	};

    // Withdraw button
	document.getElementById('withdrawBtn').onclick = async () => {
	  if (!web3 || !accounts.length) {
		statusEl.textContent = 'Please connect your wallet first.';
		return;
	  }

	  const note = document.getElementById('withdrawNote').value.trim();
	  const recipient = document.getElementById('recipientAddress').value.trim();

	  if (!note.startsWith("gothamcash-1:")) {
		statusEl.textContent = 'Invalid note (wrong format).';
		return;
	  }

	  if (!web3.utils.isAddress(recipient)) {
		statusEl.textContent = 'Please enter a valid BSC address.';
		return;
	  }

	  statusEl.textContent = 'Analyzing note...';

	  try {
		// Extract data
		const parts = note.split(':');
		if (parts.length !== 3) {
		  statusEl.textContent = 'Incorrectly formatted note.';
		  return;
		}

		const nullifierHex = parts[1];
		const secretHex = parts[2];

		// Format verification
		if (!nullifierHex.startsWith('0x') || !secretHex.startsWith('0x')) {
		  statusEl.textContent = 'Invalid note: hexadecimal format expected.';
		  return;
		}

		// Compound the full note as string hex for keccak256
		const fullNoteHex = nullifierHex + secretHex.slice(2); // concatenate without 0x

		const commitment = web3.utils.keccak256(fullNoteHex);
		const nullifierHash = web3.utils.keccak256(nullifierHex);

		statusEl.textContent = 'Processing withdrawal...';

		await contract.methods.withdraw(nullifierHash, commitment, recipient).send({ from: accounts[0] });

		statusEl.textContent = 'Withdrawal processed successfully!';

	  } catch (err) {
		console.error(err);
		statusEl.textContent = 'Withdrawal error: ' + err.message;
	  }
	};
	
	document.getElementById('useConnectedAddress').addEventListener('change', function () {
	  const recipientInput = document.getElementById('recipientAddress');
	  if (this.checked) {
		if (accounts.length > 0) {
		  recipientInput.value = accounts[0];
		  recipientInput.disabled = true;
		} else {
		  statusEl.textContent = 'No connected wallet address available.';
		  this.checked = false;
		  recipientInput.disabled = false;
		}
	  } else {
		recipientInput.value = '';
		recipientInput.disabled = false;
	  }
	});
	
	async function updateDepositStats() {
	  if (!web3Stats || !contractStats) return;

	  try {
		const balanceWei = await web3Stats.eth.getBalance(contractAddress);
		const balanceBNB = parseFloat(web3Stats.utils.fromWei(balanceWei, "ether"));
		const count = Math.floor(balanceBNB / 0.1);
		document.getElementById('depositCount').textContent = `Equivalent deposits: ${count}`;
	  } catch (e) {
		console.warn('Could not fetch contract balance');
	  }
	}

	function formatTimeAgo(timestamp) {
	  const now = Math.floor(Date.now() / 1000);
	  const seconds = now - timestamp;
	  const minutes = Math.floor(seconds / 60);
	  const hours = Math.floor(minutes / 60);
	  const days = Math.floor(hours / 24);

	  if (days > 0) return `${days} jour${days > 1 ? "s" : ""}`;
	  if (hours > 0) return `${hours} heure${hours > 1 ? "s" : ""}`;
	  if (minutes > 0) return `${minutes} minute${minutes > 1 ? "s" : ""}`;
	  return `${seconds} seconde${seconds > 1 ? "s" : ""}`;
	}
	
	window.addEventListener('load', () => {
	  initStatsReader();
	  updateDepositStats();
	});
  </script>
  
<div id="noteModal" style="
  display: none;
  position: fixed;
  top: 0; left: 0;
  width: 100vw; height: 100vh;
  background: rgba(0,0,0,0.6);
  backdrop-filter: blur(3px);
  z-index: 9999;
  align-items: center;
  justify-content: center;
">
  <div style="
    background: #1a1a1a;
    color: white;
    padding: 1.5em;
    border-radius: 10px;
    width: 90%;
    max-width: 500px;
    text-align: center;
    position: relative;
  ">
    <h3>🎉 Deposit confirmed</h3>
	<br>
    <p>Here's your note. Store it in a safe place:</p>
    <input id="noteField" readonly style="
      width: 100%;
      background: #111;
      color: #fff;
      border: 1px solid #444;
      padding: 0.6em;
      margin-top: 0.5em;
      border-radius: 6px;
      font-size: 0.9em;
    " />
    <br>
    <button id="copyNoteBtn" style="padding: 0.5em 1em; margin-bottom: 1em;">📋 Copy the note</button>
    <center><div id="noteQR" style="margin: 1em auto;"></div></center>
    <button onclick="closeNoteModal()" style="
      background: #444;
      color: white;
      border: none;
      padding: 0.5em 1em;
      border-radius: 5px;
      cursor: pointer;
    ">Close</button>
  </div>
  <br>
</div>

<script>
	function showNoteModal(note) {
	  document.getElementById('noteField').value = note;
	  document.getElementById('noteModal').style.display = 'flex';

	  // Copy on click
	  document.getElementById('copyNoteBtn').onclick = () => {
		navigator.clipboard.writeText(note)
		  .then(() => {
			document.getElementById('copyNoteBtn').textContent = '✅ Copied!';
			setTimeout(() => {
			  document.getElementById('copyNoteBtn').textContent = '📋 Copy the note';
			}, 1500);
		  });
	  };

	  // QR Code
	  const qrContainer = document.getElementById('noteQR');
	  qrContainer.innerHTML = ''; // Reset
	  new QRCode(qrContainer, {
		text: note,
		width: 150,
		height: 150,
		colorDark: "#ffffff",
		colorLight: "#1a1a1a",
		correctLevel: QRCode.CorrectLevel.M
	  });
	}

	function closeNoteModal() {
	  document.getElementById('noteModal').style.display = 'none';
	}
</script>

</body>
</html>
